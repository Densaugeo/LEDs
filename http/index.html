<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">

<title>Template</title>

<script type="text/javascript">
// Frame buster
if(top !== self) {
  top.location.replace(self.location.href);
}
</script>

<style type='text/css'>
</style>
</head>

<body>
</body>

<script type="text/javascript">

//////////////
// Controls //
//////////////

var forgeElement = function(tagName, properties, children) {
  var element = document.createElement(tagName);
  for(var i in properties) {
    element[i] = properties[i];
  }
  if(children) {
    for(var i = 0, endi = children.length; i < endi; ++i) {
      element.appendChild(children[i]);
    }
  }
  return element;
}
var fE = forgeElement;

var leds = [];

var LED = function(number) {
  this.state = Uint16Array([number,0,0,0,27]);
  
  this.div = fE('div', {}, [
    this.red   = fE('input', {type: 'range', min: 0, max: 4095, value: 0}),
    this.green = fE('input', {type: 'range', min: 0, max: 4095, value: 0}),
    this.blue  = fE('input', {type: 'range', min: 0, max: 4095, value: 0}),
    this.alpha = fE('input', {type: 'range', min: 0, max: 4095, value: 0}),
  ]);
  
  with(this) this.update = function(array) {
    this.state.set(array);
    
    red.value = state[1];
    green.value = state[2];
    blue.value = state[3];
    alpha.value = state[4];
  }
  
  with(this) red.addEventListener('input', function(e) {
    state[1] = red.value;
    ws.send(state.buffer);
  });
  
  with(this) green.addEventListener('input', function(e) {
    state[2] = green.value;
    ws.send(state.buffer);
  });
  
  with(this) blue.addEventListener('input', function(e) {
    state[3] = blue.value;
    ws.send(state.buffer);
  });
  
  with(this) alpha.addEventListener('input', function(e) {
    state[4] = alpha.value;
    ws.send(state.buffer);
  });
  
  document.body.appendChild(this.div);
}

for(var i = 0; i < 5; ++i) {
  leds[i] = new LED(i);
}

///////////////
// WebSocket //
///////////////

var ws =  new WebSocket('ws://' + window.location.host + '/');
ws.binaryType = 'arraybuffer';

// Receive state data from relay server
ws.onmessage = function(e) {
  var view = Uint16Array(e.data);
  
  if(leds[view[0]]) {
    leds[view[0]].update(view);
  }
}

/////////////////////
// Startup scripts //
/////////////////////

eval(localStorage.onstart);

</script>
</html>
