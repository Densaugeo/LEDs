<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">

<title>LED Lights!</title>

<link rel="stylesheet" href="lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="lib/PanelUI/PanelUI_light.css" id="light_colors">
<link rel="stylesheet" href="lib/PanelUI/PanelUI_dark.css" id="dark_colors">
<link rel="stylesheet" href="lib/PanelUI/PanelUI.css">

<style type="text/css">
.panel {
  position: relative;
  top: 12px;
  margin-bottom: 24px;
  left: calc(50% - 100px);
  max-width: 200px;
}
.panel_drag {
  display: none;
}
.led_sliders {
  text-align: center;
}
</style>

<script type="text/javascript">
// Frame buster
if(top !== self) {
  top.location.replace(self.location.href);
}
</script>

<script type="text/javascript" src="lib/draggabilly.pkgd.min.js"></script>
<script type="text/javascript" src="lib/DF.js"></script>
<script type="text/javascript" src="lib/PanelUI/PanelUI.js"></script>
</head>

<body>
<div id="sidebar">
<i id="contrast_button" class="fa fa-adjust button" title="Flip Contrast"></i>
<i id="clear_button"    class="fa fa-trash-o button" title="Clear Local Storage&#xA;&#xA;This will clear contrast and position settings"></i>
</div>

<div id="background"></div>
</body>

<script type="text/javascript">
///////////////
// Utilities //
///////////////

// Daisy-chainable HTMLElement maker
var fE = PanelUI.forgeElement;

var Panel = function(options) {
  PanelUI.Panel.call(this, options);
  
  this.domElement.appendChild((this.led = new LED(0)).div);
  
  this.open();
}
Panel.prototype = Object.create(PanelUI.Panel.prototype);
Panel.prototype.constructor = Panel;

var LED = function(number) {
  DF.Node.call(this);
  
  this.state = Uint16Array([number,0,0,0,0]);
  
  this.div = fE('div', {className: 'led_sliders'}, [
    this.red   = fE('input', {type: 'range', min: 0, max: 4095, value: 0, _statePosition: 1}),
    this.green = fE('input', {type: 'range', min: 0, max: 4095, value: 0, _statePosition: 2}),
    this.blue  = fE('input', {type: 'range', min: 0, max: 4095, value: 0, _statePosition: 3}),
    this.alpha = fE('input', {type: 'range', min: 0, max: 4095, value: 0, _statePosition: 4}),
  ]);
  
  with(this) this.update = function(array) {
    state.set(array);
    
    red.value = state[1];
    green.value = state[2];
    blue.value = state[3];
    alpha.value = state[4];
  }
  
  with(this) div.addEventListener('input', function(e) {
    state[e.target._statePosition] = e.target.value;
    emit('input', {type: 'input', led: number, buffer: state.buffer});
  }, true);
  
  document.body.appendChild(this.div);
}
LED.prototype = Object.create(DF.Node.prototype);
LED.prototype.constructor = LED;

///////////////
// Instances //
///////////////

var sidebar = new PanelUI.Sidebar();
sidebar.addButton({buttonName: 'contrast', faClass: 'fa-adjust' , title: 'Flip Contrast'      });
sidebar.addButton({buttonName: 'clear'   , faClass: 'fa-recycle', title: 'Clear local storage'});

var bg = document.getElementById('background');

var panels = [];
panels[0] = new Panel({id: 'lamp1', heading: 'Floor Lamp'});
panels[1] = new Panel({id: 'lamp2', heading: 'Futon Lamp'});
panels[2] = new Panel({id: 'lamp3', heading: 'Lamp 3'    });
panels[3] = new Panel({id: 'lamp4', heading: 'Lamp 4'    });
panels[4] = new Panel({id: 'lamp5', heading: 'Lamp 5'    });

var darkColors = document.getElementById('dark_colors');

var leds = [];

panels.forEach(function(v, i, a) {
  leds[i] = v.led;
});

////////////
// Events //
////////////

sidebar.on('contrast', function(e) {
  if(darkColors.parentNode === document.head) {
    document.head.removeChild(darkColors);
    localStorage.contrast = 'light';
  } else {
    document.head.appendChild(darkColors);
    localStorage.contrast = 'dark';
  }
});

sidebar.on('clear', function(e) {
  localStorage.clear();
});

////////////////////
// Initialization //
////////////////////

if(localStorage.contrast === 'light') {
  document.head.removeChild(darkColors);
}

///////////////
// WebSocket //
///////////////

var ws =  new WebSocket('ws://' + window.location.host + '/');
ws.binaryType = 'arraybuffer';

// Receive state data from relay server
ws.onmessage = function(e) {
  var view = Uint16Array(e.data);
  
  if(leds[view[0]]) {
    leds[view[0]].update(view);
  }
}

for(var i = 0, endi = leds.length; i < endi; ++i) {
  leds[i].on('input', function(e) {
    ws.send(e.buffer);
  });
}

/////////////////////
// Startup scripts //
/////////////////////

eval(localStorage.onstart);

</script>
</html>
